\chapter{Build Conventions}
%==========================
This sections details the environment setup to enable the CRTM library, or any support software, to be compiled in a user's working copy. For the purposes of explanation we will assume that the entire CRTM trunk working copy has been checked out using something like the following commands,
\begin{ttfamily}
  \begin{verbatim}
     cd $HOME/CRTM
     svn checkout https://svnemc.ncep.noaa.gov/projects/crtm/trunk trunk\end{verbatim}
\end{ttfamily}
where a user's home directory is referred to by the environment variable \f{\$HOME}, and the root directory of a user's working copy of the CRTM is \f{\$HOME/CRTM} and reflects the same directory structure as the repository.

Additionally, it is assumed there exists a user directory, \f{\$HOME/bin}, which is defined in a user's \f{\$PATH}. Compiled executables and scripts will be placed in this directory by the \f{install} target common to all makefiles.


\section{Macro Definitions}
%--------------------------
All of the makefiles in the CRTM repository use environment variables as required to locate the particular category subdirectories described in table \ref{tab:trunk_category_description}. The environment variable names, along with example definitions for a working copy are shown in table

\begin{table}[htb]
  \centering
  \begin{tabular}{p{6.5cm} p{7.5cm}}
    \hline
    \sffamily\textbf{Environment Variable Name} & \sffamily\textbf{Example Definition} \\
    \hline\hline
    \f{CRTM\_ROOT}              & \f{\$HOME/CRTM/trunk} \\
    \f{CRTM\_SOURCE\_ROOT}      & \f{\$CRTM\_ROOT/src}\\
    \f{CRTM\_FIXFILE\_ROOT}     & \f{\$CRTM\_ROOT/fix} \\
    \f{CRTM\_TEST\_ROOT}        & \f{\$CRTM\_ROOT/test} \\
    \f{CRTM\_SCRIPTS\_ROOT}     & \f{\$CRTM\_ROOT/scripts} \\
    \f{CRTM\_EXTERNALS\_ROOT}   & \f{\$CRTM\_ROOT/externals} \\
    \f{CRTM\_DOC\_ROOT}         & \f{\$CRTM\_ROOT/doc} \\
    \f{CRTM\_VALIDATION\_ROOT}  & \f{\$CRTM\_ROOT/validation} \\
    \hline
  \end{tabular}
  \caption{Environment variables used by CRTM makefiles.}
  \label{tab:macro_description}
\end{table}

Ideally, the environment variables of table \ref{tab:macro_description} should be defined in a user's environment definition file to ensure they will be defined in any shell invocation.

For now, just note the multiple examples for the \f{CRTM\_SOURCE\_ROOT} macro. The reason for this will be explained later (see section \ref{sec:crtm_build}).


\section{Install of script files}
%--------------------------------
The simplest way to build a library is to have all the source code in a single directory. The CRTM source code modules in the \f{src} directory, however, are organised into separate subdirectory hierarchies according to their application. It is expected that this organisational structure will change over time. Rather than create makefiles that need to know what the directory structure is to find all the various source files, a shell script (\f{linkfiles}) is used to link all the necessary files into the CRTM library build subdirectory, \f{src/Build}.

So, the second step in setting up the CRTM build environment is to install the necessary scripts. The current method for doing this is through unsophisticated use of makefiles. The sequence of commands for the script install are,
\begin{ttfamily}
  \begin{verbatim}
     cd $CRTM_SCRIPTS_ROOT/shell/Utility
     make install\end{verbatim}
\end{ttfamily}
This installs all the scripts currently used in the CRTM build process. Note there is also an uninstall target that removes all the scripts from a user's local \f{bin} directory.

\section{Master Make Include Files}
%----------------------------------
\label{sec:make_includes}
All of the makefiles in the CRTM repository use three standard include files: \f{make.macros}, \f{make.common\_targets} and \f{make.rules}. These files reside in the \f{CRTM\_SOURCE\_ROOT} subdirectory and their function is described in table \ref{tab:make_includes}.

\begin{table}[htb]
  \centering
  \begin{tabular}{p{4.5cm} p{9.5cm}}
    \hline
    \sffamily\textbf{Include File Name} & \sffamily\textbf{Description} \\
    \hline\hline
    \f{make.macros}          & Defines macros for all the compiler and linker flags for the supported compiler/platform combinations, as well as commonly used operating system commands and utilities, e.g. \f{cp}, \f{rm}, \f{ar}, etc. \\
    \f{make.common\_targets} & Defines the common targets used in builds, e.g. \f{all}, \f{install}, \f{clean}, etc. \\
    \f{make.rules}           & Defines the suffix rules for compiling Fortran source code. \\
    \hline
  \end{tabular}
  \caption{Include files used by CRTM makefiles.}
  \label{tab:make_includes}
\end{table}


\section{Building the CRTM Library}
%----------------------------------
\label{sec:crtm_build}
Having setup the environment on a system, the sequence of commands to build and install the CRTM library in a checked out working copy is,
\begin{ttfamily}
  \begin{verbatim}
     cd $CRTM_SOURCE_ROOT
     make create_links
     make
     make install\end{verbatim}
\end{ttfamily}
The first target, \f{create\_links}, searches for all the required CRTM source code starting at \f{\$CRTM\_SOURCE\_ROOT} and links it all into the \f{Build/src} subdirectory\footnote{For some systems, notably the IBM systems at NCEP, this can take several minutes. For linux desktop systems, it should only take a few seconds. A ruby version of the script does exist that is quite a bit faster.}.

The second make does the actual source code compilation and library creation.

The last target, \f{install}, moves the created CRTM library, \f{libCRTM.a}, into the \f{Build/lib} subdirectory and all of the associated \f{*.mod} module files into the \f{Build/include} subdirectory.

If you wish to build a particular branch or release (tag) of the CRTM library, all you need to do is redefine the \f{CRTM\_SOURCE\_ROOT} environment variable to your working copy location for that branch or release. The redefinition can be system-wide (e.g. if you're working solely on a release branch in preparation for the release) or for a single shell session (e.g. if you're building an older or experimental version alongside the current release).

If the build is a final one (e.g. you're not testing the CRTM), the \f{Build/lib} and \f{Build/include} subdirectories are typically copied or moved to a generic location outside of the working copy, e.g. \f{\$HOME/local/lib} and \f{\$HOME/local/include}, or \f{\$HOME/local/CRTM/lib} and \f{\$HOME/local/CRTM/include}

As mentioned in section \ref{sec:make_includes}, compiler flags for varous platforms (or in the case of linux, for various compilers) are defined in the \f{make.macros} file. Instructions on how to modify the \f{make.macros} for different compilers on a linux systems can be found in the \f{Build/README} file.

\section{Cleaning up}
%--------------------
There are three targets that tidy up after a CRTM build. Depending on your needs they clean up intermediate files to varying degrees. A description of the clean targets is shown in table \ref{tab:clean_up}.

\begin{table}[htb]
  \centering
  \begin{tabular}{p{2.5cm} p{11.5cm}}
    \hline
    \sffamily\textbf{Target Name} & \sffamily\textbf{Description} \\
    \hline\hline
    \f{clean}     & Removes all the \f{*.o}, \f{*.mod}, \f{*.a} files from the \f{Build/src} subdirectory. \\
    \f{distclean} & Same as \f{clean} but also deletes the \f{Build/lib} and \f{Build/include} subdirectories. \\
    \f{realclean} & Same as \f{distclean} but also deletes the source code symbolic links in the \f{Build/src} subdirectory.\\
    \hline
  \end{tabular}
  \caption{Cleanup targets in the CRTM library build makefiles.}
  \label{tab:clean_up}
\end{table}
If you invoke the \f{realclean} target and want to subsequently rebuild the CRTM libarry, you will have to recreate the links as detailed in section \ref{sec:crtm_build}. And, remember, creating the links can take some time on some systems.

