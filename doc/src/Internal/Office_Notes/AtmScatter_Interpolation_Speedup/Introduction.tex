\section{Introduction}
%=====================
A central design principle of the components of the CRTM Tangent-linear (TL) and Adjoint (AD) models is that the Forward model is always called first. Thus, in principle, forward model calculations are always available for the various TL and AD components.

The REL-1.1 CRTM AtmScatter modules obtained the interpolated cloud and aerosol optical properties from the CloudCoeff and AerosolCoeff lookup tables (LUTs) as shown in figure \ref{fig:AtmScatter_Interpolation}. For the tangent-linear and adjoint models (figures \ref{fig:AtmScatter_Interpolation}(b) and (c)), the necessary interpolation parameters such as the bracketing indices and interpolating polynomials were always recomputed.
 
\begin{figure}[htp]
  \centering
  \input{graphics/Flowcharts/AtmScatter_Interpolation.pstex_t}
  \caption{Schematic flowcharts of the REL-1.1 CRTM Forward, Tangent-linear, and Adjoint routines used to interpolate the cloud and aerosol optical properties from the CloudCoeff and AerosolCoeff lookup tables. The forward component of the interpolation is recomputed in the tangent-linear and adjoint routines.}
  \label{fig:AtmScatter_Interpolation}
\end{figure}

The CRTM already saves the intermediate forward model results for its components in private structures, i.e. the structure definition is public, but the internals are private. We call these structures the internal variables for the particular CRTM component (e.g. AtmAbsorption, CloudScatter, AerosolScatter, etc).

To avoid the unnecessary forward model recalculations for the cloud and aerosol property LUT interpolations, separate structures were created to retain the intermediate LUT interpolation results, and added to the main internal variable structure. The structure used for cloudy atmospheres is shown in figure \ref{fig:CSinterp_structure} and its usage in the CloudScatter internal variable structure is shown in figure \ref{fig:CSVariables_structure}. Similar, the aerosol structure is shown in figure \ref{fig:ASinterp_structure}, and its usage in the AerosolScatter internal variable structure is shown in figure \ref{fig:ASVariables_structure}. Because the cloud optical properties in the microwave are dependent upon an additional parameter (temperature), a different structure is defined for cloud and aerosol computations to minimise memory usage.

\begin{figure}[htp]
  \centering
  \doublebox{
  \begin{minipage}[b]{6.5in}
    \begin{ttfamily}
      \begin{verbatim}
      
  TYPE :: CSinterp_type                              
    ! The interpolating polynomials                  
    TYPE(LPoly_type) :: wlp  ! Frequency             
    TYPE(LPoly_type) :: xlp  ! Effective radius      
    TYPE(LPoly_type) :: ylp  ! Temperature           
    ! The LUT interpolation indices                  
    INTEGER :: i1, i2        ! Frequency             
    INTEGER :: j1, j2        ! Effective radius      
    INTEGER :: k1, k2        ! Temperature           
    ! The LUT interpolation boundary check           
    LOGICAL :: f_outbound    ! Frequency             
    LOGICAL :: r_outbound    ! Effective radius      
    LOGICAL :: t_outbound    ! Temperature           
    ! The interpolation input                        
    REAL(fp) :: f_int        ! Frequency             
    REAL(fp) :: r_int        ! Effective radius      
    REAL(fp) :: t_int        ! Temperature           
    ! The data to be interpolated                    
    REAL(fp) :: f(NPTS)      ! Frequency             
    REAL(fp) :: r(NPTS)      ! Effective radius      
    REAL(fp) :: t(NPTS)      ! Temperature           
  END TYPE CSinterp_type                             
      \end{verbatim}
    \end{ttfamily}
  \end{minipage}
  }
  \caption{The structure definition to hold the forward model cloud optical properties lookup table  interpolation results.}
  \label{fig:CSinterp_structure}
\end{figure}

\begin{figure}[htp]
  \centering
  \doublebox{
  \begin{minipage}[b]{6.5in}
    \begin{ttfamily}
      \begin{alltt}
      
  TYPE :: CRTM_CSVariables_type
    PRIVATE
    ! The interpolation data
    \hyperref[fig:CSinterp_structure]{TYPE(CSinterp_type) :: csi(MAX_N_LAYERS, MAX_N_CLOUDS)}
    ! The interpolation results
    REAL(fp) :: ke(MAX_N_LAYERS, MAX_N_CLOUDS)  ! Mass extinction coefficient
    REAL(fp) :: w(MAX_N_LAYERS, MAX_N_CLOUDS)   ! Single scatter albedo
    REAL(fp) :: g(MAX_N_LAYERS, MAX_N_CLOUDS)   ! Asymmetry factor
    REAL(fp) :: pcoeff(0:MAX_N_LEGENDRE_TERMS,&
                       MAX_N_PHASE_ELEMENTS,  &
                       MAX_N_LAYERS,          &
                       MAX_N_CLOUDS           ) ! Phase coefficient
    ! The accumulated scattering coefficient
    REAL(fp) :: Total_bs(MAX_N_LAYERS)          ! Volume scattering coefficient
  END TYPE CRTM_CSVariables_type
      \end{alltt}
    \end{ttfamily}
  \end{minipage}
  }
  \caption{The structure definition to hold all the forward model CloudScatter results showing the added \texttt{csi} structure array used to hold the intermediate interpolation results. The array dimensions are declared in the \texttt{CRTM\_Parameters} module.}
  \label{fig:CSVariables_structure}
\end{figure}

\begin{figure}[htp]
  \centering
  \doublebox{
  \begin{minipage}[b]{6.5in}
    \begin{ttfamily}
      \begin{verbatim}
      
  TYPE :: ASinterp_type
    ! The interpolating polynomials
    TYPE(LPoly_type) :: wlp  ! Frequency
    TYPE(LPoly_type) :: xlp  ! Effective radius
    ! The LUT interpolation indices
    INTEGER :: i1, i2        ! Frequency
    INTEGER :: j1, j2        ! Effective radius
    ! The LUT interpolation boundary check
    LOGICAL :: f_outbound    ! Frequency
    LOGICAL :: r_outbound    ! Effective radius
    ! The interpolation input
    REAL(fp) :: f_int        ! Frequency
    REAL(fp) :: r_int        ! Effective radius
    ! The data to be interpolated
    REAL(fp) :: f(NPTS)      ! Frequency
    REAL(fp) :: r(NPTS)      ! Effective radius
  END TYPE ASinterp_type
      \end{verbatim}
    \end{ttfamily}
  \end{minipage}
  }
  \caption{The structure definition to hold the forward model aerosol optical properties lookup table  interpolation results.}
  \label{fig:ASinterp_structure}
\end{figure}

\begin{figure}[htp]
  \centering
  \doublebox{
  \begin{minipage}[b]{6.5in}
    \begin{ttfamily}
      \begin{alltt}
      
  TYPE :: CRTM_ASVariables_type
    PRIVATE
    ! The interpolation data
    \hyperref[fig:ASinterp_structure]{TYPE(ASinterp_type) :: asi(MAX_N_LAYERS, MAX_N_AEROSOLS)}
    ! The interpolation result
    REAL(fp) :: ke(MAX_N_LAYERS, MAX_N_AEROSOLS)  ! Mass extinction coefficient
    REAL(fp) :: w(MAX_N_LAYERS, MAX_N_AEROSOLS)   ! Single scatter albedo
    REAL(fp) :: g(MAX_N_LAYERS, MAX_N_AEROSOLS)   ! Asymmetry factor
    REAL(fp) :: pcoeff(0:MAX_N_LEGENDRE_TERMS,&
                       MAX_N_PHASE_ELEMENTS,  &
                       MAX_N_LAYERS,          &
                       MAX_N_AEROSOLS         )   ! Phase coefficient
    ! The accumulated scattering coefficient
    REAL(fp) :: Total_bs(MAX_N_LAYERS)            ! Volume scattering coefficient
  END TYPE CRTM_ASVariables_type
      \end{alltt}
    \end{ttfamily}
  \end{minipage}
  }
  \caption{The structure definition to hold all the forward model AerosolScatter results showing the added \texttt{asi} structure array used to hold the intermediate interpolation results. The array dimensions are declared in the \texttt{CRTM\_Parameters} module.}
  \label{fig:ASVariables_structure}
\end{figure}

With the intermediate interpolation results now available for reuse, the tangent-linear and adjoint routines now avoid the forward model recalculations altogether, as shown schematically in figure \ref{fig:AtmScatter_Interpolation.new}.

\begin{figure}[htp]
  \centering
  \input{graphics/Flowcharts/AtmScatter_Interpolation.new.pstex_t}
  \caption{Schematic flowcharts of the REL-1.2 CRTM Forward, Tangent-linear, and Adjoint routines used to interpolate the cloud and aerosol optical properties from the CloudCoeff and AerosolCoeff lookup tables. The forward component of the interpolation is now saved in a structure variable and reused in the tangent-linear and adjoint routines.}
  \label{fig:AtmScatter_Interpolation.new}
\end{figure}

The timing data that follows compares the CloudScatter and AerosolScatter component tests for a baseline (revision 2757) and modified (revision 2787) version of the CRTM library from the RB-1.2 branch.
